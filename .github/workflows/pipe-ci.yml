name: CI

on:
  push:
    branches: ["main"]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build services
        run: docker compose -f docker-compose.yml build

      - name: Install dependencies
        run: |
            docker compose run --rm php_coin composer install --no-interaction || \
            docker compose run --rm php_coin composer update --no-interaction

      - name: Wait for SonarQube to be ready
        run: |
          echo "Waiting for SonarQube..."
          until curl -s http://sonarqube:9000/api/system/status | grep -q "UP"; do
            sleep 5
            echo "Waiting..."
          done
          echo "SonarQube is up!"

      - name: Install SonarQube Scanner
        run: |
          sudo apt-get update && sudo apt-get install -y unzip
          wget -O sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip sonar-scanner.zip
          sudo mv sonar-scanner-5.0.1.3006-linux /opt/sonar-scanner
          echo "export PATH=/opt/sonar-scanner/bin:\$PATH" >> ~/.bashrc
          echo "export SONAR_SCANNER_OPTS='-server'" >> ~/.bashrc
          source ~/.bashrc

      - name: Run SonarQube scan
        run: |
          /opt/sonar-scanner/bin/sonar-scanner \
            -Dsonar.projectKey=clement-test \
            -Dsonar.sources=. \
            -Dsonar.host.url=http://localhost:9000 \
            -Dsonar.login=sqp_809ea7182dc8aba63f0b2d963066201fae4a98bb

      - name: PHP-CS-Fixer
        run: docker compose run --rm php_coin ./vendor/bin/php-cs-fixer fix --dry-run --diff

      - name: PHPStan
        run: |
          docker compose run --rm php_coin ./vendor/bin/phpstan analyse src --level=5

      - name: All tests
        run: |
          docker compose run --rm php_coin ./vendor/bin/phpunit --testdox

      - name: Clean up
        if: always()
        run: docker compose down
